{% extends "base/base.html" %}
{% load static %}
{% block extra_css %}
{% endblock extra_css %}
{% block extra_head_js %}
<script>
  (function () {
    window.onload = function () {
      var preloader = document.querySelector('.page-loading');
      if (preloader) {
        preloader.classList.remove('active');
        setTimeout(function () { preloader.remove(); }, 500);
      }
    };
  })();
</script>
{% endblock extra_head_js %}
{% block body %}
<main class="page-wrapper">
  {% include "partials/loading_spinner.html" %}
  {% include "partials/SignInModal.html" %}
  {% include "partials/SignUpModal.html" %}
  {% include "partials/header.html" %}

  <div class="container mt-5 pt-md-3 py-4 py-lg-5">
    {% include "partials/breadcrumbs.html" %}
    {% if messages %}
    {% for m in messages %}
    <div class="alert alert-{{ m.tags }} alert-dismissible fade show" role="alert">{{ m }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    {% endfor %}
    {% endif %}

    {% with landing_cover=category.get_landing_cover_image %}
    {% if landing_cover %}
    <div class="mb-4 rounded overflow-hidden" style="max-height: 360px;">
      <img src="{{ landing_cover.image.url }}" alt="{{ landing_cover.alt|default:category.fa_name }}" class="w-100" style="height: 360px; object-fit: cover;">
    </div>
    {% endif %}
    {% endwith %}

    <h1 class="mb-3">{{ seo_h1|default:category.fa_name }}</h1>
    <p class="text-muted mb-4">جستجوی سراسری بر اساس دسته‌بندی</p>
    {% if intro_content %}
    <p class="lead text-muted">{{ intro_content }}</p>
    {% endif %}

    {# زیردسته‌ها #}
    {% if children %}
    <section class="mb-5">
      <h2 class="h5 mb-3">زیردسته‌های {{ category.fa_name }}</h2>
      <div class="d-flex flex-wrap gap-2">
        {% for child in children %}
        <a href="/s/{{ child.slug }}/" class="btn btn-outline-secondary btn-sm">{{ child.fa_name }}</a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# آگهی‌های دسته‌بندی #}
    <section class="mb-5">
      <h2 class="h5 mb-4">آگهی‌های {{ category.fa_name }}</h2>
      {% if listings %}
      <div class="row g-4">
        {% for listing in listings %}
        <div class="col-sm-6 col-lg-4 col-xl-3">
          {% include "partials/listing_card.html" %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-muted">فعلاً آگهی‌ای در این دسته ثبت نشده است.</p>
      {% endif %}
    </section>

    {# محتوای اصلی #}
    {% if main_content %}
    <section class="mt-5 pt-4 border-top">
      <div class="content">{{ main_content|safe }}</div>
    </section>
    {% endif %}

    {# مقالات بلاگ مرتبط با دسته‌بندی #}
    {% if category_posts %}
    <section class="mt-5 pt-5 border-top">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="h5 mb-0 font-vazir">مقالات مرتبط با {{ category.fa_name }}</h2>
        <a class="btn btn-link fw-normal p-0" href="{% url 'blog:index' %}">مشاهده همه<i class="fi-arrow-long-left ms-2"></i></a>
      </div>
      <div class="row g-4">
        {% for post in category_posts %}
        <div class="col-sm-6 col-lg-4">
          {% include "partials/blog_post_card.html" with post=post %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% include "partials/landing_lead_form.html" with landing_lead_heading="دریافت مشاوره رایگان برای "|add:category.fa_name %}
  </div>

  {% include "partials/footer.html" %}
  {% include "partials/Backtotopbutton.html" %}
  {% include "base/scripts.html" %}
</main>
{% endblock body %}
{% block extra_js %}
{% endblock extra_js %}
