{% extends "base/base.html" %}
{% load static panel_tags %}
{% block extra_css %}
{% endblock extra_css %}
{% block extra_head_js %}
<script>
  (function () {
    window.onload = function () {
      var preloader = document.querySelector('.page-loading');
      if (preloader) {
        preloader.classList.remove('active');
        setTimeout(function () { preloader.remove(); }, 500);
      }
    };
  })();
</script>
{% endblock extra_head_js %}
{% block body %}
<main class="page-wrapper">
  {% include "partials/loading_spinner.html" %}
  {% include "partials/SignInModal.html" %}
  {% include "partials/SignUpModal.html" %}
  {% include "partials/header.html" %}

  <!-- Page header -->
  <section class="container pt-5 mt-5">
    {% include "partials/breadcrumbs.html" %}

    <div class="d-sm-flex align-items-center justify-content-between mb-4 pb-sm-2">
      <h1 class="h2 me-3 mb-sm-0">{{ seo_h1 }}</h1>
      <div class="text-nowrap">
        <div class="dropdown d-inline-block" data-bs-toggle="tooltip" title="اشتراک‌گذاری">
          <button class="btn btn-icon btn-light-primary btn-xs shadow-sm rounded-circle" type="button" data-bs-toggle="dropdown"><i class="fi-share"></i></button>
          <div class="dropdown-menu dropdown-menu-end my-1">
            <button class="dropdown-item" type="button" onclick="shareUrl('facebook')"><i class="fi-facebook fs-base opacity-75 me-2"></i>فیسبوک</button>
            <button class="dropdown-item" type="button" onclick="shareUrl('twitter')"><i class="fi-twitter fs-base opacity-75 me-2"></i>توییتر</button>
            <button class="dropdown-item" type="button" onclick="shareUrl('telegram')"><i class="fi-telegram fs-base opacity-75 me-2"></i>تلگرام</button>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills border-bottom pb-3 mb-4">
      <li class="nav-item"><a class="nav-link d-flex align-items-center active" href="#info"><i class="fi-info-circle me-2"></i>اطلاعات</a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="#listings"><i class="fi-list me-2"></i>آگهی‌ها</a></li>
    </ul>
  </section>

  <!-- Main content -->
  <section class="container pb-5 mb-md-4" id="info">
    <div class="row">
      <div class="col-md-7 mb-md-0 mb-4 pb-md-0 pb-2">
        {% if landing_cover %}
        <div class="mb-4 rounded overflow-hidden">
          <img src="{{ landing_cover.image.url }}" alt="{{ landing_cover.alt|default:agency.name }}" class="w-100 rounded-3" style="max-height: 320px; object-fit: cover;">
        </div>
        {% endif %}

        <h2 class="h5">درباره {{ agency.name }}</h2>
        <ul class="list-unstyled mb-3">
          {% if agency.phone %}
          <li><i class="fi-phone mt-n1 me-1 align-middle opacity-70"></i>{{ agency.phone }}</li>
          {% endif %}
          {% if agency.address %}
          <li><i class="fi-map-pin mt-n1 me-1 align-middle opacity-70"></i>{{ agency.address }}</li>
          {% endif %}
        </ul>
        <div class="mb-4 pb-md-3">
          {% if agency.intro_content %}
          <p class="mb-2 line-h18">{{ agency.intro_content }}</p>
          {% endif %}
          {% if agency.main_content %}
          <div class="content">{{ agency.main_content|safe }}</div>
          {% endif %}
          {% if not agency.intro_content and not agency.main_content %}
          <p class="text-muted mb-0">مشاوره املاک {{ agency.name }} آماده ارائه خدمات خرید، فروش و اجاره املاک است.</p>
          {% endif %}
        </div>

        {% if agency.cities.exists %}
        <div class="mb-4 pb-md-3">
          <h2 class="h5">شهرهای تحت فعالیت</h2>
          <ul class="list-unstyled row row-cols-lg-3 row-cols-md-2 row-cols-1 gy-1 mb-1">
            {% for city in agency.cities.all %}
            <li class="col"><a href="/s/{{ city.slug }}/" class="text-decoration-none"><i class="fi-map-pin mt-n1 me-2 align-middle opacity-70"></i>{{ city.fa_name }}</a></li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if agency.owner or employees %}
        <div class="mb-4 pb-md-3">
          <h2 class="h5">تیم مشاوره</h2>
          <div class="row g-2">
            {% if agency.owner %}
            <div class="col-sm-6">
              <div class="d-flex align-items-center gap-2 p-2 rounded bg-light">
                {% if agency.owner.avatar %}
                <img src="{{ agency.owner.avatar.url }}" alt="{{ agency.owner.get_full_name|default:agency.owner.username }}" class="rounded-circle flex-shrink-0" style="width: 40px; height: 40px; object-fit: cover;">
                {% else %}
                <div class="rounded-circle bg-faded-primary d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
                  <i class="fi-user text-primary"></i>
                </div>
                {% endif %}
                <div class="min-w-0">
                  <div class="fw-medium">{% if agency.owner|is_agent %}<a href="{{ agency.owner.get_absolute_url }}" class="text-decoration-none">{{ agency.owner.get_full_name|default:agency.owner.username }}</a>{% else %}{{ agency.owner.get_full_name|default:agency.owner.username }}{% endif %} <span class="badge bg-primary fs-xs">مالک</span></div>
                  <small class="text-muted">{{ agency.owner.get_role_display }}</small>
                  {% if agency.owner.phone %}
                  <br><small><a href="tel:{{ agency.owner.phone }}">{{ agency.owner.phone }}</a></small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            {% for employee in employees %}
            <div class="col-sm-6">
              <div class="d-flex align-items-center gap-2 p-2 rounded bg-light">
                {% if employee.avatar %}
                <img src="{{ employee.avatar.url }}" alt="{{ employee.get_full_name|default:employee.username }}" class="rounded-circle flex-shrink-0" style="width: 40px; height: 40px; object-fit: cover;">
                {% else %}
                <div class="rounded-circle bg-faded-primary d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
                  <i class="fi-user text-primary"></i>
                </div>
                {% endif %}
                <div class="min-w-0">
                  <div class="fw-medium">{% if employee|is_agent %}<a href="{{ employee.get_absolute_url }}" class="text-decoration-none">{{ employee.get_full_name|default:employee.username }}</a>{% else %}{{ employee.get_full_name|default:employee.username }}{% endif %}</div>
                  <small class="text-muted">{{ employee.get_role_display }}</small>
                  {% if employee.phone %}
                  <br><small><a href="tel:{{ employee.phone }}">{{ employee.phone }}</a></small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Sidebar -->
      <aside class="col-md-5">
        <div class="card mb-4 p-2 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-start mb-3 pb-2 border-bottom">
              {% if agency.logo %}
              <img src="{{ agency.logo.url }}" alt="{{ agency.name }}" width="60" height="60" class="rounded flex-shrink-0 object-fit-cover">
              {% else %}
              <div class="rounded bg-faded-primary d-flex align-items-center justify-content-center flex-shrink-0" style="width: 60px; height: 60px;">
                <i class="fi-building text-primary fs-3"></i>
              </div>
              {% endif %}
              <div class="ps-2 ms-1">
                <h3 class="h5 mb-2">{{ agency.name }}</h3>
                <ul class="list-unstyled d-flex flex-wrap fs-sm">
                  {% if agency.phone %}
                  <li class="me-2 mb-1 pe-1"><i class="fi-phone mt-n1 me-1 align-middle opacity-70"></i>{{ agency.phone }}</li>
                  {% endif %}
                  {% if agency.cities.exists %}
                  <li class="me-2 mb-1 pe-1"><i class="fi-map-pin mt-n1 me-1 align-middle opacity-70"></i>{{ agency.cities.first.fa_name }}</li>
                  {% endif %}
                </ul>
              </div>
            </div>
            <div class="mb-3 pb-3 border-bottom">
              <h4 class="h5 mb-2">تماس با ما</h4>
              <ul class="nav flex-column">
                {% if agency.address %}
                <li class="nav-item mb-2"><span class="d-flex align-items-start"><i class="fi-map-pin mt-1 me-2 align-middle opacity-70"></i>{{ agency.address }}</span></li>
                {% endif %}
                {% if agency.phone %}
                <li class="nav-item mb-2"><a class="nav-link p-0 fw-normal d-inline-flex align-items-start" href="tel:{{ agency.phone }}"><i class="fi-phone mt-1 me-2 align-middle opacity-70"></i>{{ agency.phone }}</a></li>
                {% endif %}
              </ul>
            </div>
            {% if agency.phone %}
            <div class="mb-3 pb-4 border-bottom">
              <a class="btn btn-primary btn-lg rounded-pill w-100" href="tel:{{ agency.phone }}"><i class="fi-phone me-2"></i>تماس با مشاوره</a>
            </div>
            {% endif %}
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- Listings -->
  <section class="container pb-5 mb-lg-4" id="listings">
    <div class="d-flex align-items-center justify-content-between mb-4 pb-2">
      <h2 class="h3 mb-0">آگهی‌های {{ agency.name }}</h2>
      <a class="btn btn-link fw-normal ms-sm-3 p-0" href="{% url 'listing_catalog' %}">مشاهده همه<i class="fi-arrow-long-left ms-2"></i></a>
    </div>
    {% if listings %}
    <div class="row g-4">
      {% for listing in listings %}
      <div class="col-sm-6 col-lg-4 col-xl-3">
        {% include "partials/listing_card.html" %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">فعلاً آگهی‌ای از این مشاوره ثبت نشده است.</p>
    {% endif %}
  </section>

  {% include "partials/footer.html" %}
  {% include "partials/Backtotopbutton.html" %}
  {% include "base/scripts.html" %}

  <script>
    function shareUrl(platform) {
      var url = encodeURIComponent(window.location.href);
      var text = encodeURIComponent(document.title);
      var urls = {
        facebook: 'https://www.facebook.com/sharer/sharer.php?u=' + url,
        twitter: 'https://twitter.com/intent/tweet?url=' + url + '&text=' + text,
        telegram: 'https://t.me/share/url?url=' + url + '&text=' + text
      };
      if (urls[platform]) window.open(urls[platform], '_blank', 'width=600,height=400');
    }
  </script>
</main>
{% endblock body %}
{% block extra_js %}
{% endblock extra_js %}
