{% extends "panel/base.html" %}
{% block panel_content %}
<div class="mb-3">{% include "partials/breadcrumbs.html" %}</div>

<div class="card shadow-sm mb-4">
  <div class="card-body p-4">
    <h2 class="h5 mb-3">افزودن همکار به املاک</h2>
    <p class="text-muted small mb-4">
      نام کاربری یا شماره موبایل همکار را وارد کنید تا دعوت همکاری برای املاک انتخاب‌شده ارسال شود.
      عضویت فقط بعد از تایید خود کاربر فعال می‌شود.
    </p>
    <form method="post" class="row g-3">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_employee" />
      <div class="col-md-4">
        <label class="form-label">املاک</label>
        <select name="agency_id" class="form-select" required>
          <option value="">انتخاب املاک...</option>
          {% for a in agencies %}
          <option value="{{ a.id }}">{{ a.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">نام کاربری یا موبایل</label>
        <input type="text" name="identifier" class="form-control" placeholder="مثال: 0912... یا username" required />
      </div>
      <div class="col-md-3 d-grid">
        <label class="form-label d-none d-md-block">&nbsp;</label>
        <button type="submit" class="btn btn-primary">ارسال دعوت</button>
      </div>
    </form>
  </div>
</div>

<h3 class="h6 mb-3">دعوت‌های در انتظار تایید</h3>
{% if pending_invites %}
<div class="card shadow-sm mb-4">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>نام</th>
          <th>نام خانوادگی</th>
          <th>کاربر</th>
          <th>املاک</th>
          <th>تاریخ دعوت</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for inv in pending_invites %}
        <tr>
          <td>{{ inv.invited_user.first_name|default:"-" }}</td>
          <td>{{ inv.invited_user.last_name|default:"-" }}</td>
          <td>{{ inv.invited_user.phone|default:inv.invited_user.username }}</td>
          <td>{{ inv.agency.name }}</td>
          <td>{{ inv.created_at|date:"Y/m/d H:i" }}</td>
          <td>
            <form method="post" class="d-inline" onsubmit="return confirm('این دعوت لغو شود؟');">
              {% csrf_token %}
              <input type="hidden" name="action" value="cancel_invite" />
              <input type="hidden" name="invite_id" value="{{ inv.id }}" />
              <button type="submit" class="btn btn-sm btn-outline-warning">لغو دعوت</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="card shadow-sm mb-4">
  <div class="card-body text-center py-4">
    <p class="text-muted mb-0">دعوت در انتظار تاییدی برای املاک شما وجود ندارد.</p>
  </div>
</div>
{% endif %}

<h3 class="h6 mb-3">همکاران فعال</h3>
{% if employees %}
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>نام</th>
          <th>نام خانوادگی</th>
          <th>کاربر</th>
          <th>املاک</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for e in employees %}
        <tr>
          <td>{{ e.first_name|default:"-" }}</td>
          <td>{{ e.last_name|default:"-" }}</td>
          <td>{{ e.phone|default:e.username }}</td>
          <td>{{ e.agency.name }}</td>
          <td>
            <form method="post" class="d-inline" onsubmit="return confirm('این همکار حذف شود؟');">
              {% csrf_token %}
              <input type="hidden" name="action" value="remove_employee" />
              <input type="hidden" name="user_id" value="{{ e.id }}" />
              <button type="submit" class="btn btn-sm btn-outline-danger">حذف همکار</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="card shadow-sm">
  <div class="card-body text-center py-5">
    <p class="text-muted mb-0">هنوز همکاری برای املاک‌های شما ثبت نشده است.</p>
  </div>
</div>
{% endif %}
{% endblock %}
