{% extends "panel/base.html" %}
{% load static panel_tags %}
{% block extra_css %}
<style>
/* theme hides all file inputs - show icon upload */
.icon-upload-wrapper input[type="file"] { display: block !important; width: auto; }
</style>
{% endblock %}
{% block panel_content %}
<div class="mb-3">{% include "partials/breadcrumbs.html" %}</div>
<div class="card shadow-sm">
  <div class="card-body p-4">
    <h2 class="h5 mb-4">{% if object %}ویرایش ویژگی{% else %}افزودن ویژگی{% endif %}</h2>
    <form method="post" id="attribute-form" enctype="multipart/form-data">
      {% csrf_token %}
      {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% if form.errors or formset.non_form_errors %}
      <div class="alert alert-danger">
        <strong>خطاها:</strong>
        <ul class="mb-0 mt-2">
          {% for field, errs in form.errors.items %}
            {% for e in errs %}
            <li><strong>{% if field == 'categories' %}دسته‌بندی‌ها{% elif field == 'name' %}نام{% elif field == 'slug' %}اسلاگ{% elif field == 'value_type' %}نوع مقدار{% elif field == 'unit' %}واحد{% elif field == 'icon' %}آیکون{% elif field == 'sort_order' %}ترتیب{% else %}{{ field }}{% endif %}:</strong> {{ e }}</li>
            {% endfor %}
          {% endfor %}
          {% for e in formset.non_form_errors %}
            <li>{{ e }}</li>
          {% endfor %}
          {% for f in formset.forms %}
            {% if f.errors %}
              {% for field, errs in f.errors.items %}
                {% for e in errs %}
                <li>گزینه {{ forloop.parentloop.parentloop.counter }} - {{ field }}: {{ e }}</li>
                {% endfor %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="id_name">نام فارسی *</label>
          {{ form.name }}
          {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label" for="id_value_type">نوع مقدار *</label>
          {{ form.value_type }}
        </div>
        <div class="col-md-4">
          <label class="form-label" for="id_unit">واحد</label>
          {{ form.unit }}
        </div>
        <div class="col-md-4">
          <label class="form-label" for="id_sort_order">ترتیب نمایش</label>
          {{ form.sort_order }}
        </div>
        <div class="col-12">
          <label class="form-label d-block">آیکون</label>
          <p class="text-muted small mb-2">فقط PNG یا SVG، حداکثر ۶۴ کیلوبایت، ابعاد حداکثر ۱۲۸×۱۲۸</p>
          <div class="icon-upload-wrapper border rounded p-3 bg-light">
            {{ form.icon }}
          </div>
          {% if form.instance and form.instance.icon %}<p class="small mt-1 mb-0">فعلی: <a href="{{ form.instance.icon.url }}" target="_blank">{{ form.instance.icon.name }}</a> — برای تغییر، فایل جدید انتخاب کنید.</p>{% endif %}
          {% if form.icon.errors %}<div class="text-danger small">{{ form.icon.errors }}</div>{% endif %}
        </div>
        <div class="col-12">
          <label class="form-label">دسته‌بندی‌ها</label>
          <div class="border rounded p-3" style="max-height: 220px; overflow-y: auto;">
            <div class="row g-2">
              {% for choice in form.categories %}
              <div class="col-md-6 col-lg-4">
                <div class="form-check">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                </div>
              </div>
              {% empty %}
              <div class="col-12 text-muted">دسته‌بندی فعالی وجود ندارد.</div>
              {% endfor %}
            </div>
          </div>
          <small class="text-muted">تیک بزنید برای انتخاب. خالی = ویژگی برای همه دسته‌ها</small>
          {% if form.categories.errors %}<div class="text-danger small">{{ form.categories.errors }}</div>{% endif %}
        </div>
        <div class="col-12">
          <div class="form-check">
            {{ form.is_active }}
            <label class="form-check-label" for="id_is_active">فعال</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-check">
            {{ form.is_filterable }}
            <label class="form-check-label" for="id_is_filterable">نمایش در فیلترها</label>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h6 class="mb-2">گزینه‌ها (برای نوع «انتخابی»)</h6>
      <p class="text-muted small mb-3">مقادیر از پیش تعریف‌شده برای ویژگی انتخابی، مثلاً: ۱، ۲، ۳، ۴ برای «تعداد اتاق»</p>
      {% if formset.non_form_errors %}
      <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}
      {{ formset.management_form }}
      <div class="table-responsive mb-2">
        <table class="table table-sm" id="options-table">
          <thead>
            <tr>
              <th>مقدار</th>
              <th>ترتیب</th>
              {% if formset.can_delete %}<th>حذف</th>{% endif %}
            </tr>
          </thead>
          <tbody id="options-tbody">
            {% for f in formset %}
            <tr class="option-row">
              <td>{{ f.value }}{% if f.value.errors %}<div class="text-danger small">{{ f.value.errors }}</div>{% endif %}</td>
              <td>{{ f.sort_order }}{% if f.sort_order.errors %}<div class="text-danger small">{{ f.sort_order.errors }}</div>{% endif %}</td>
              {% if formset.can_delete %}
              <td>{% if f.DELETE %}{{ f.DELETE }}{% endif %}</td>
              {% endif %}
              {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
            </tr>
            {% endfor %}
          </tbody>
          <tbody id="empty-option-template" style="display:none">
            <tr class="option-row">
              <td>{{ formset.empty_form.value }}</td>
              <td>{{ formset.empty_form.sort_order }}</td>
              {% if formset.can_delete %}
              <td>{{ formset.empty_form.DELETE }}</td>
              {% endif %}
              {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-option-btn">
        <i class="fi-plus me-1"></i>افزودن گزینه
      </button>

      <div class="mt-4">
        <button type="submit" class="btn btn-primary">{% if object %}ویرایش{% else %}ذخیره{% endif %}</button>
        <a class="btn btn-outline-secondary me-2" href="{% url 'panel:attribute_list' %}">انصراف</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
  var btn = document.getElementById('add-option-btn');
  var tbody = document.getElementById('options-tbody');
  var templateTbody = document.getElementById('empty-option-template');
  if (!btn || !tbody || !templateTbody) return;
  var mgmtForm = document.getElementById('id_options-TOTAL_FORMS');
  btn.addEventListener('click', function() {
    var total = mgmtForm ? parseInt(mgmtForm.value, 10) : 0;
    var row = templateTbody.querySelector('tr').cloneNode(true);
    var regex = new RegExp('__prefix__', 'g');
    row.querySelectorAll('input, select, textarea').forEach(function(inp) {
      if (inp.name) inp.name = inp.name.replace(regex, total);
      if (inp.id) inp.id = inp.id.replace(regex, total);
      if (inp.type === 'checkbox' || inp.type === 'radio') {
        inp.checked = false;
      } else if (inp.name && inp.name.indexOf('sort_order') !== -1) {
        inp.value = total + 1;
      } else {
        inp.value = '';
      }
    });
    row.querySelectorAll('label').forEach(function(lbl) {
      if (lbl.getAttribute('for')) lbl.setAttribute('for', lbl.getAttribute('for').replace(regex, total));
    });
    tbody.appendChild(row);
    if (mgmtForm) mgmtForm.value = total + 1;
  });
})();
</script>
{% endblock %}
