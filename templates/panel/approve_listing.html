{% extends "panel/base.html" %}
{% load humanize %}
{% block panel_content %}
<div class="mb-3">{% include "partials/breadcrumbs.html" %}</div>

<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h2 class="h5 mb-0">تأیید آگهی: {{ listing.title }}</h2>
    <div>
      <a href="{% url 'panel:listing_edit' listing.pk %}" class="btn btn-sm btn-outline-secondary" target="_blank">
        <i class="fi-edit me-1"></i>ویرایش در پنل
      </a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'panel:approve_dashboard' %}">بازگشت</a>
    </div>
  </div>
  <div class="card-body p-4">
    {% if listing.rejection_reason %}
    <div class="alert alert-warning mb-4" role="alert">
      <strong>ارسال مجدد پس از رد:</strong>
      <p class="mb-0 mt-2">دلیل رد قبلی: {{ listing.rejection_reason }}</p>
    </div>
    {% endif %}
    <p class="text-muted mb-3">
      <i class="fi-user me-1"></i>ایجادکننده: {{ listing.created_by.get_full_name|default:listing.created_by.username }}
      {% if listing.agency %} | <i class="fi-building me-1"></i>{{ listing.agency.name }}{% endif %}
    </p>

    <!-- خلاصه و مکان -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <span class="badge bg-secondary me-1">{{ listing.get_deal_display }}</span>
        <span class="badge bg-light text-dark">{{ listing.city.fa_name }}{% if listing.area %}، {{ listing.area.fa_name }}{% endif %}</span>
        <span class="badge bg-light text-dark">{{ listing.category.fa_name }}</span>
      </div>
      {% if listing.has_price_display %}
      <div class="col-md-6 text-md-end">
        <span class="badge bg-primary fs-6">
          {% if listing.deal == 'mortgage_rent' %}
            {% if listing.price_mortgage %}رهن {{ listing.price_mortgage|floatformat:0|intcomma }}{% endif %}{% if listing.price_mortgage and listing.price %} | {% endif %}{% if listing.price %}اجاره {{ listing.price|floatformat:0|intcomma }}{% endif %}
          {% else %}
            {{ listing.price|floatformat:0|intcomma }}
          {% endif %}
          {{ listing.price_unit|default:"تومان" }}
        </span>
      </div>
      {% endif %}
    </div>

    <!-- تصاویر -->
    {% if listing.images.all %}
    <div class="mb-4">
      <h4 class="h6 mb-2">تصاویر ({{ listing.images.all|length }})</h4>
      <div class="d-flex flex-wrap gap-2">
        {% for img in listing.images.all %}
        <a href="{{ img.image.url }}" target="_blank" rel="noopener" class="d-block rounded overflow-hidden" style="max-width: 120px;">
          <img src="{{ img.image.url }}" alt="{{ img.alt|default:listing.title }}" class="img-fluid" style="height: 90px; object-fit: cover;">
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- ویژگی‌ها -->
    {% with attrs_with_value=listing.attribute_values.all %}
    {% if attrs_with_value %}
    <div class="mb-4">
      <h4 class="h6 mb-2">ویژگی‌ها</h4>
      <div class="row row-cols-sm-2 g-2">
        {% for av in attrs_with_value %}
          {% if av.value_int is not None or av.value_bool is not None or av.value_str or av.value_option_id %}
        <div class="col"><span class="text-muted">{{ av.attribute.name }}:</span> {{ av.display_value }}</div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}
    {% endwith %}

    {% if listing.short_description %}
    <div class="mb-4">
      <h4 class="h6 mb-2">خلاصه</h4>
      <p class="mb-0">{{ listing.short_description }}</p>
    </div>
    {% endif %}

    {% if listing.description %}
    <div class="mb-4">
      <h4 class="h6 mb-2">توضیحات</h4>
      <div class="content border rounded p-3 bg-light">{{ listing.description|safe }}</div>
    </div>
    {% endif %}

    <!-- دکمه‌های تأیید و رد -->
    <div class="d-flex flex-wrap gap-2 pt-3 border-top">
      <form method="post" class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="action" value="approve">
        <button type="submit" class="btn btn-success">
          <i class="fi-check me-1"></i>تأیید و انتشار
        </button>
      </form>
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
        <i class="fi-x me-1"></i>رد آگهی
      </button>
    </div>
  </div>
</div>

<!-- مودال رد آگهی -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="reject">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel">رد آگهی</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">علت رد را بنویسید تا صاحب آگهی بتواند ایراد را برطرف کرده و دوباره ثبت کند.</p>
          <label for="rejection_reason" class="form-label">علت رد <span class="text-danger">*</span></label>
          <textarea name="rejection_reason" id="rejection_reason" class="form-control" rows="4" required placeholder="مثال: تصاویر با کیفیت کافی نیست. لطفاً توضیحات کامل‌تری بنویسید."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">انصراف</button>
          <button type="submit" class="btn btn-danger">رد و بازگردانی به پنل آگهی‌گذار</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
